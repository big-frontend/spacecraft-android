import groovy.json.JsonSlurper

def child(Object msg) {
    println("ðŸ‘¶[ gradle initialzation ] " + msg);
}

include ':app'
//apply from: "./buildSrc/src/main/groovy/module-config.groovy"
//apply from: "./buildSrc/src/main/groovy/module-config.gradle"

/**
 * è¯»å–module_config.jsonä¿¡æ¯ä»¥æ­¤æ¥includeå…·ä½“çš„æ¨¡å—ï¼Œå¯¹äºŽæ¨¡å—çš„æè¿°åº”è¯¥æœ‰è¿™äº›ä¿¡æ¯
 * class Module{
 *    require  def simpleName æ¨¡å—åçš„ç®€å†™,ç»™idea pluginè¯»å–
 *    require def canonicalName :components:hotel-module:foundation
 *    require def format æ¨¡å—æ ¼å¼(bundle/bundle foundation/framework foundation/jar ,bundleå¯ä»¥ä¸å‚åŠ ç¼–è¯‘ï¼Œå³excludeï¼Œä½†æ˜¯framwork foundationå¿…é¡»è¢«include)
 *    option def deps
 *    ä¸åº”æœ‰è¿™ä¸ªå±žæ€§ï¼Œè¦ç¼–è¯‘æˆä»€ä¹ˆåº”è¯¥é€šè¿‡excludeModuleå’ŒsourceModule,é»˜è®¤éƒ½æ˜¯aarç¼–è¯‘//option def build_source(source or binary),binary(aar jar)ç¼–è¯‘æ›´å¿«
 *    require def binary_artifact default: {package}:simpleName:1.0.0 ,é»˜è®¤çš„binary_artifactéœ€è¦ä¿è¯simpelNameå”¯ä¸€æ€§,å…ˆæš‚æ—¶ç”¨1.0.0ç«™ä½ï¼ŒåŽé¢åº”è¯¥é€šè¿‡èŽ·å–è¿œç¨‹ç‰ˆæœ¬å’Œæœ¬åœ°ç‰ˆæœ¬è¿›è¡Œè‡ªåŠ¨å‡çº§
 *}*
 */
def config = new JsonSlurper().parse(file("./buildSrc/module_config.json"))
gradle.ext.allModules = config.allModules
def localProperties = new Properties()
def localPropertiesFile = new File(rootDir, 'local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}
def excludeModulesStr = localProperties.getProperty('excludeModules', '')
def sourceModulesStr = localProperties.getProperty('sourceModules', '')
gradle.ext.excludeModuleMap = [:]
gradle.ext.sourceModuleMap = [:]
gradle.ext.binaryModuleMap = [:]

excludeModulesStr.split(',').each { src ->
    gradle.ext.allModules.each { m ->
        if (m.simpleName == src) {
            gradle.ext.excludeModuleMap[m.canonicalName] = m
        }
    }
}
sourceModulesStr.split(',').each { src ->
    gradle.ext.allModules.each { m ->
        if (m.simpleName == src) {
            gradle.ext.sourceModuleMap[m.canonicalName] = m
        }
    }
}

gradle.ext.allModules.each { m ->
    if (!gradle.ext.sourceModuleMap.containsKey(m.canonicalName) && !gradle.ext.excludeModuleMap.containsKey(m.canonicalName)) {
        gradle.ext.binaryModuleMap[m.canonicalName] = m
    }
}

//include ':components:hotel-module:foundation'
//include ':components:hotel-module:hotel-lint'
//include ':components:hotel-module:bundle1'
//include ':components:hotel-module:bundle2'
//include ':components:myhome',
//        ':components:login'
//include ':components:template'
//include ':components:module1'
//include ':mockserver'
//include ':framework:common', ':framework:loader',':framework:router',
//        ':framework:network', ':framework:storage', ':framework:image',
//        ':framework:av', ':framework:map', ':framework:chatroom',
//        ':framework:uicomponent'
child("include module begin ========================================================================================")
gradle.ext.sourceModuleMap.each { _,module ->
    child("source module  ${module.canonicalName}")
    include module.canonicalName
    if (module.path) {
        project(module.canonicalName).projectDir = new File(rootProject.projectDir, module.path)
    }

}
gradle.ext.binaryModuleMap.each { _,module ->
    child("binary module  ${module.canonicalName}")
    include module.canonicalName
    if (module.path) {
        project(module.canonicalName).projectDir = new File(rootProject.projectDir, module.path)
    }

}
child("include module end ========================================================================================")
//setBinding(new Binding([gradle: this]))
//evaluate(new File(settingsDir, 'script/flutter/include_flutter.gradle'))
//include ':gradle-plugin'
//include ':lint-rules'
//include ':lint-checker'
//include ':instrumentation:annotations', ':instrumentation:processor'

